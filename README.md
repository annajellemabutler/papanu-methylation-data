## Baboon DNA methylation changes with age
*Winter 2024 Rotation Project: Soojin Yi Lab*

Pipeline [^1] for the recreation of the results of a [chapter of Hyeonsoo Jeong's thesis](https://docs.google.com/document/d/1TZFuVnaIoU6e3bUsUtpBu0H6r37STyjj/edit), including: (1) DNA methylation data analysis from anubis baboons, (2) development of an aging CpG clock, and (3) further exploratory analysis relating to the relationship between epigenetic aging and early life rearing experience. 

### Data
The data were generated by reduced-representation bisulfite sequencing of blood-derived DNA from 140 *Papio anubis* baboons of a broad age-span. RRBS libraries were constructed using the NuGEN Library Preparation kit and sequenced on an Illumina HiSeq3000 system using 57 bp single-end reads. 

All my data is located in /home/annajellema/papanu on UCSB's Pod Cluster. The raw sequencing reads are located in fasta files (one per baboon?) in `rawdata`, while the *P. anubis* reference genome is located in `refgenome` (`papAnu4.fa.gz`).

### Noobie Preparations
As this was my first time working on an HPC, I have detailed below the preparatory steps I took in order to be able to run the analysis. 

#### One-Time Setup
- Install miniconda in home directory on Pod cluster using [this tutorial](https://github.com/um-dang/conda_on_the_cluster?tab=readme-ov-file).
- Install the relevant packages to a project-specific environment (`dnam`) using `conda install <package_name>`. These included `samtools`, `bismark`, `bowtie2`.

#### Upon Every Log-In
- When you login to the cluster using ssh [^2], you arrive at a login node, which should only be used for basic editing/transferring of files and submitting jobs.
- For long running jobs, submit the jobs to the queue using `sbatch`.
- For compiling, installing, or testing code (e.g., real-time data exploration, code devleopment, etc.) use interactive computing. This runs on a set of compute nodes. You can request an interactive computing node with 4 cores for 4 hours by runnning `srun -N 1 -n 4 -p batch --time=4:00:00 --pty bash -i`.
- Activate environment

## Overview of Pipeline 
1. Quality control (trimming, adaptor removal)
2. Bismark read alignment and methylation calling
3. De-duplication
4. Methylation extraction

## Quality Control
_Command (on compute node):_ `srun trimgalore_job.sh`
_Dependencies: trim_galore

- This bash script automates the process of running Trim Galore v.0.4.1 on each Fasta file.
- Run the program with default parameters and do not use the `--rrbs` option.
- Behind-the-scenes
  - `trim_galore` is a wrapper script that combines Cutadapt (adapter trimming tool) and FastQC (quality control tool).
  - First, low-quality base calls are trimmed from the 3' end.
  - Next, Cutadapt finds and removes 3' adapter sequences.
  - Lastly, it filters out trimmed reads < 20 bp 

_Command (on compute node):_ `python trimdiversityadaptors.py -1 *_trimmed.fq.gz`
_Dependencies: trim_galore, bismark, bowtie2, samtools

- The NuGEN diversity adaptors must also be removed prior to alignment.
- The script used is a python3-converted version of the python2 script [provided by NuGEN](https://github.com/nugentechnologies/NuMetRRBS). 
- Behind-the-scenes
  - The script trims reads at the 5' end to remove the diversity sequence (0-3 bases). All reads should begin with `YGG` (where `Y` is `C` or `T`).
  - On the 3' end, 5 bases are trimmed from every read. 
  - The script removes any reads that do not contain an MspI site signature (`YGG`) at the 5' end.
  - The script generates new file(s) with _trimmed.fq appended to the filename.

## 2. Alignment to genome
After triming, the data can be aligned to the reference genome. Bismark v 0.14. was used to align sequencing reads to the baboon papAnu4 reference genome and perform methylation calling in the same step. There are two main steps to running Bismark: (a) genome preparation and (b) read alignment. 

### (a) Genome preparation 
_Command_: `bismark_genome_preparation --verbose /home/annajellema/papanu/refgenome`

- Behind-the-scences
  - First, Bismark prepares the folders for its output: `Bisulfite_Genome/CT_conversion` and `Bisulfite_Genome/GA_conversion`.
  - Second, it performs the genome bisulfite conversions (in one instance, converting all Cs to Ts, and in the other, all the Gs to As).
  - Third, it launches the Bowtie2 indexer (this can take a while), which will be used to index the converted genomes in parallel. Indexing allows for efficient mapping later on. 

### (b) Read alignment
_Command_:`bismark --genome <path_to_prepared_genome_folder --bowtie2 sequence_file.trimmed.gz`. 

- Behind-the-scenes
  - For each sequence file, Bismark produces one alignment and methylation call output file.
  - Generates a BAM file. This must be converted to a SAM file in order to perform the duplicate determination step. 

## 3. De-duplication
De-duplication was performed to remove PCR duplicates. The script works by checking whether the start and end co-ordinate of the mapped read coincides with any other read. If it does, it gets discarded. 

`~/tools/bismark_v0.17.0/deduplicate_bismark --bam -p blah_R1.trim_bismark_bt2_pe.bam`

## 4. Methylation extraction
This is an optional step. The number of methylated and unmethylated reads on a per-position basis can be called using `~/tools/bismark_v0.17.0/bismark_methylation_extractor -p --bedGraph --counts --scaffolds --multicore 8 blah_R1.trim_bismark_bt2_pe.deduplicated.bam`.

3. Exploratory analysis 

(A) Elastic net regression 
- Removed CpGs with a mean methylation level < 0.1 or > 0.9 and with a coverage < 5 and with missing data
- The DNA methylation clock was built using elastic net regression, using the R package glmnet. 
- The optimal regularization parameter, lambda, was determined by 10-fold cross-validation on the data using cv.glmnet. 
- Estimated the DNA methylation age of each individual using the leave-one-out cross-validation approach

(B) Functional enrichment
- Looked at the genomic distribution of the clock CpG sites
- Occurences of CpGs for each genomic feature were compared with those in random control sets (G+C content-matched)
- Genomic co-ordinates of functional genomic regions were downloaded from UCSC Genome Browser. 

(C) Identification of differentially-methylated CpGs
- For each site, we fitted a linear model to estimate the interaction effect of age and rearing experience. 
- Generalized linear models were created with the DSS (2.4) Bioconductor package. 
- Sex and bisulfite conversion rates were considered covariates. 
- Conducted a hypothesis test of the interaction effect using Wald test (based on the estimated co-efficient and standard error from the fitted model). Used the Benjamini-Hochberg method for multiple-testing correction. 

[^1]: The document is written from the perspective of someone with no experience working on an HPC and, therefore, may include extraneous details.
[^2]: See [UCSB tutorial](https://csc.cnsi.ucsb.edu/sites/default/files/2024-03/HPC_01_Winter_24.pdf)
